{% load staticfiles %}
<link href="{% static 'css/apexcharts/apexcharts.css' %}" rel="stylesheet">
<style>
    .chart-row:before {
        display: table;
    }

    .chart-row {
        padding-top: 10px;
        min-height: 600px;
        padding-bottom: 25px;
    }

    .column-25 {
        width: 25%;
        float: left;
    }

    .column-75 {
        width: 75%;
        float: left;
    }

    .column-50 {
        width: 50%;
        float: left;
        padding: 15px;
    }

    .height-100 {
        height: 150px;
    }

    .well-table-container {
        height: 430px;
        overflow-y: auto;
        background-color: #ffffff;
        box-shadow: 0px 2px 6px 0px rgba(0, 0, 0, 0.07);
    }

    .title {
        color: #24619d;
    }

    .well-table-container td {
        border: 1px solid #ebebeb;
        padding: 14px 18px;
        color: #333333;
    }

    .table-description {
        padding: 20px;
        line-height: 1.4;
    }

    .well-info {
        line-height: 200px;
        height: 100%;
        position: relative;
    }

    .well-info p {
        margin: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #24619d;
    }

</style>


<div class="chart-row">
    <div class="column-25 height-100">
        <div class="charts-header">
            <h3>Well Chart</h3>
        </div>
        <div class="charts" id="well-chart-container">
        </div>
    </div>
    <div class="column-75">
        <h3>Well information</h3>
        <div id="well-table-container" class="well-table-container">
            <div class="well-info">
                <p>Please hover over the chart on the left</p>
            </div>
        </div>
    </div>
</div>

<script id="well-charts-table-template" type="text/template">
    <div class="column-50">
        <div class="title">
            <h4>Construction</h4>
        </div>
        <table>
            <tr>
                <td width="30%">Casing or screen</td>
                <td><%= construction.type %></td>
            </tr>
            <tr>
                <td>Top depth</td>
                <td><%= construction.top %></td>
            </tr>
            <tr>
                <td>Bottom depth</td>
                <td><%= construction.bottom %></td>
            </tr>
            <tr>
                <td>Diameter</td>
                <td><%= construction.data.diameter %></td>
            </tr>
            <tr>
                <td>Material</td>
                <td><%= construction.data.material %></td>
            </tr>
        </table>
    </div>
    <div class="column-50" style="margin-bottom: 50px;">
        <div class="title">
            <h4>Stratigraphy</h4>
            <table>
            <tr>
                <td width="30%">Top depth</td>
                <td><%= stratigraphy.top %></td>
            </tr>
            <tr>
                <td>Bottom depth</td>
                <td><%= stratigraphy.bottom %></td>
            </tr>
            <tr>
                <td>Material</td>
                <td><%= stratigraphy.data.material %></td>
            </tr>
            <tr>
                <td>Stratigraphy Unit</td>
                <td><%= stratigraphy.data.unit %></td>
            </tr>
        </table>
        </div>
    </div>
    <div class="table-description">
        <h5>Description</h5>
        <%= construction.data.description %>
    </div>
</script>

<script type="text/javascript"
        src="{% static 'js/apexcharts/apexcharts.min.js' %}"></script>
<script type="text/javascript"
        src="{% static 'js/chroma.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/underscore-1.11.0/underscore-min.js' %}"></script>
<script>

    $(function () {
        let chartData = {
            'stratigraphy': [{
                'top': 0,
                'bottom': 10,
                'id': 1,
                'data': {
                    'material': 'clay',
                    'unit': 'upper devonian'
                }
            }, {
                'top': 10,
                'bottom': 30,
                'id': 2,
                'data': {
                    'material': 'soil',
                    'unit': 'lower devonian'
                }
            },{
                'top': 30,
                'bottom': 40,
                'id': 3,
                'data': {
                    'material': 'soil',
                    'unit': 'lower devonian'
                }
            }],
            'construction': [{
                'top': 0,
                'bottom': 20,
                'id': 1,
                'type': 'casing',
                'data': {
                    'diameter': '20mm',
                    'material': 'pvc',
                    'description': 'lorem ipsum'
                }
            }, {
                'top': 20,
                'bottom': 25,
                'id': 2,
                'type': 'casing 2',
                'data': {
                    'diameter': '30mm',
                    'material': 'pvc 2',
                    'description': 'lorem ipsum 2'
                }
            }, {
                'top': 25,
                'bottom': 30,
                'id': 3,
                'type': 'casing 3',
                'data': {
                    'diameter': '30mm',
                    'material': 'pvc 2',
                    'description': 'lorem ipsum 2'
                }
            }, {
                'top': 30,
                'bottom': 40,
                'id': 4,
                'type': 'casing 4',
                'data': {
                    'diameter': '30mm',
                    'material': 'pvc 2',
                    'description': 'lorem ipsum 2'
                }
            }]
        }
        createWellChart(chartData, 'well-chart-container', 'well-table-container');
    });

    /**
     * Render chart with chartData to a div with id of chartId
     * @param chartData, example : {
            'stratigraphy': [{
                'top': 0,
                'bottom': 10,
                'id': 1,
                'data': {
                    'material': 'clay',
                    'unit': 'upper devonian'
                }
            }, {
                'top': 10,
                'bottom': 30,
                'id': 2,
                'data': {
                    'material': 'soil',
                    'unit': 'lower devonian'
                }
            }],
            'construction': [{
                'top': 0,
                'bottom': 20,
                'id': 1,
                'data': {
                    'casing or screen': 'casing',
                    'diameter': '20mm',
                    'material': 'pvc',
                    'description': 'lorem ipsum'
                }
            }, {
                'top': 20,
                'bottom': 40,
                'id': 2,
                'data': {
                    'casing or screen': 'casing 2',
                    'diameter': '30mm',
                    'material': 'pvc 2',
                    'description': 'lorem ipsum 2'
                }
            }]
        }
     * @param chartId, id of the chart container div
     * @param tableContainerId, id of the table container div
     */
    function createWellChart(chartData, chartId, tableContainerId) {
        if (!chartData.hasOwnProperty('construction')) return false;
        if (!chartData.hasOwnProperty('stratigraphy')) return false;

        const stratigraphyChartId = 'stratigraphy-chart-container'
        const stratigraphyChartDiv = $(`<div id="${stratigraphyChartId}" style="position: absolute; top: 0">`);
        $(`#${chartId}`).append(stratigraphyChartDiv);

        const constructionChartId = 'construction-chart-container'
        const constructionChartDiv = $(`<div id="${constructionChartId}">`);
        $(`#${chartId}`).append(constructionChartDiv);

        const constructionDataSeries = [];
        let maxConstructionData = 0;
        chartData['construction'].forEach((constructionData, index) => {
            const range = constructionData['bottom'] - constructionData['top'];
            maxConstructionData += range
            constructionDataSeries.push({
                name: constructionData['id'],
                data: [range]
            })
        })

        const stratigraphyDataSeries = [];
        let maxStratigraphyData = 0;
        chartData['stratigraphy'].forEach((stratigraphyData, index) => {
            const range = stratigraphyData['bottom'] - stratigraphyData['top'];
            maxStratigraphyData += range
            stratigraphyDataSeries.push({
                name: stratigraphyData['id'],
                data: [range]
            })
        })
        const max = maxConstructionData > maxStratigraphyData ? maxConstructionData : maxStratigraphyData;
        renderChart(constructionDataSeries, `#${constructionChartId}`, max,
            {
                'center': true,
                'colors': chroma.scale(['#f1aeaa','#F44336']).mode('hcl').colors(6)
            }, (event, chartContext, config) => {
                if (!event) {
                    // $(`#${tableContainerId}`).html('');
                    return true;
                }
                const constructionData = chartData['construction'][config['seriesIndex']];
                chartData['stratigraphy'].some((stratigraphyData, index) => {
                    if (constructionData['bottom'] <= stratigraphyData['bottom']) {
                        renderTable(tableContainerId, constructionData, stratigraphyData);
                        return true;
                    }
                })
            });
        renderChart(stratigraphyDataSeries, `#${stratigraphyChartId}`, max,
            {
                'width': 418,
                'colors': chroma.scale(['#9e9fa0','#313747']).mode('hcl').colors(6),
                'opacity': 0.6
            });
    }

    function renderTable(tableContainerId, constructionData, stratigraphyData) {
        const tableDiv = $(`#${tableContainerId}`);
        const table = _.template($('#well-charts-table-template').html());
        tableDiv.html(table(
            {
                'construction': constructionData,
                'stratigraphy': stratigraphyData
            }
        ));
    }

    function renderChart(chartSeriesData, chartContainerId, maxSeriesData, options, callback = null) {
        const center = options.hasOwnProperty('center') ? options['center'] : false;
        const width = options.hasOwnProperty('width') ? options['width'] : 300;
        const colors = options.hasOwnProperty('colors') ? options['colors'] : ['#F44336', '#E91E63', '#9C27B0'];
        const opacity = options.hasOwnProperty('opacity') ? options['opacity'] : 1;
        let chartOptions = {
            series: chartSeriesData,
            chart: {
                type: 'bar',
                height: 450,
                width: width,
                stacked: true,
                events: {
                    dataPointMouseEnter: function (event, chartContext, config) {
                        if (callback) {
                            callback(event, chartContext, config);
                        }
                    },
                    dataPointMouseLeave: function (event, chartContext, config) {
                        if (callback) {
                            callback(null);
                        }
                    },
                    mounted: function (chartContext, config) {
                        if (center) {
                            $(chartContainerId).find('.apexcharts-canvas').css({
                                'margin-left': 'auto',
                                'margin-right': 'auto'
                            })
                        }
                    },
                    updated: function (chartContext, config) {
                        if (center) {
                            $(chartContainerId).find('.apexcharts-canvas').css({
                                'margin-left': 'auto',
                                'margin-right': 'auto'
                            })
                        }
                    }
                },
                toolbar: {
                    show: false
                }
            },
            tooltip: {
                enabled: false
            },
            xaxis: {
                categories: ['Depth'],
            },
            yaxis: {
                reversed: true,
                show: !center,
                max: maxSeriesData,
                axisBorder: {
                    show: false,
                },
                axisTicks: {
                    show: false
                },
                labels: {
                    formatter: function (value) {
                        return value.toFixed(2) + "m";
                    }
                }
            },
            grid: {
                show: !center
            },
            fill: {
                opacity: opacity,
                colors: colors
            },
            legend: {
                show: false
            },
            dataLabels: {
                enabled: false
            }
        };

        let chart = new ApexCharts(document.querySelector(chartContainerId), chartOptions);
        chart.render();
    }

</script>